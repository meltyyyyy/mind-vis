Bootstrap: docker
From: nvidia/cuda:11.5.2-runtime-centos7

%environment
    # base settings
    export TZ=Asia/Tokyo
    export CUDA_PATH=/usr/local/cuda
    export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH

    # project settings
    export WORKDIR=$HOME/workspace/mind-vis
    export XDG_DATA_HOME=$WORKDIR/.local/share
    export XDG_CONFIG_HOME=$WORKDIR/.config
    export XDG_CACHE_HOME=$WORKDIR/.cache

    # proxy settings
    export http_proxy=http://proxy.nict.go.jp:3128
    export https_proxy=http://proxy.nict.go.jp:3128

    # python settings
    # python
    export PYTHONPATH=$WORKDIR

    # pyenv
    export PYENV_ROOT=/opt/pyenv
    export PATH=$PYENV_ROOT/bin:$PATH
    export PATH=$PYENV_ROOT/shims:$PATH

    # poetry
    export POETRY_HOME=/opt/poetry
    export PATH=$POETRY_HOME/bin:$PATH

%post
    export DEBIAN_FRONTEND=noninteractive

    # python settings
    # python
    export PYTHON_VERSION=3.8.1

    # pyenv
    export PYENV_ROOT=/opt/pyenv
    export PATH=$PYENV_ROOT/bin:$PATH

    # poetry
    export POETRY_ROOT=/opt/poetry
    export PATH=$POETRY_ROOT/bin:$PATH

    yum -y install \
	gcc \
        make \
        curl \
        git \
	openssl-devel \
        readline-devel \
        sqlite-devel \
        xz-devel \
        zlib-devel \
        bzip2-devel \
        ncurses-devel \
        tk-devel \
        libffi-devel \
        llvm \
        wget \
        unzip \
	which \
        libSM.x86_64 \
        libXrender.x86_64 \
        libXext.x86_64

    # Install pyenv
    git clone https://github.com/pyenv/pyenv.git $PYENV_ROOT
    eval "$(pyenv init --path)"
    pyenv install $PYTHON_VERSION
    pyenv local $PYTHON_VERSION

    # Install poetry
    git clone https://github.com/python-poetry/install.python-poetry.org.git /opt/installer
    POETRY_HOME=$POETRY_ROOT python3 /opt/installer/install-poetry.py
    poetry config virtualenvs.in-project true

%labels
    Author takeru.abe
    Version v1.0.1
